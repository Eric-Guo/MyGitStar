/*! MyGitStars 08-04-2014 */
$(document).ready(function(){"use strict";var a=!1,b=1e4,c=6e4,d=$("#navHeader").attr("data-active");d&&$("#"+d).addClass("active"),$("#btnUpdate").click(function(b){if(b.preventDefault(),a){var d=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>正在更新，请勿重复提交。</p></div>');d.prependTo($(".infoBox")[0])}else $.ajax({type:"POST",timeout:c,url:"/ajaxUpdateFromGithub",success:function(a){if(a=JSON.parse(a),a.status){var b=$('<div class="row alert alert-success alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>'+a.message+"</p></div>");b.prependTo($(".infoBox")[0])}else{var c=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>'+a.message+"</p></div>");c.prependTo($(".infoBox")[0])}},error:function(){var a=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>更新超时</p></div>');a.prependTo($(".infoBox")[0])}})}),$(".tab-content").mouseover(function(a){$(a.target).closest("li").tooltip("show")}),$("#myTab a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#myTab").find("li").first().addClass("active"),$(".tab-content").find("div").first().addClass("active in"),$(".tab-content").click(function(a){a.preventDefault();var b=$(a.target).closest("li"),c=b.find(".star-name").text(),d=b.find(".star-description").text(),e=b.find(".star-owner").text(),f=$("#myModal");f.find(".modal-id").val(b.attr("data-id")),f.find(".modal-title").text(c),f.find(".modal-owner").text(e),f.find(".modal-language").text(b.find(".star-language").text()),f.find(".modal-starNum").text(b.attr("data-starNum")),f.find(".modal-forkNum").text(b.attr("data-forkNum")),f.find(".modal-repoId").text("ID: "+b.attr("data-id")),f.find(".modal-description").text(d),f.find(".modal-htmlurl").attr({href:b.attr("data-htmlurl")}),f.find(".modal-readme").attr({href:"/readme?author="+e+"&repo="+c}),f.find(".modal-size").text(b.attr("data-size")+"KB");var g=b.attr("data-category");f.find(".modal-category input").text(g),f.find(".modal-category input").val(g);var h=b.attr("data-remark");f.find(".modal-remark textarea").text(h),f.find(".modal-remark textarea").val(h),$("#myModal").modal()}),$("#sortByStar").click(function(a){a.preventDefault();var b=$(".tab-pane.active").find("ol"),c=b.find("li"),d=[];c.each(function(){var a=Number($(this).attr("data-starNum")),b={};b.num=a,b.li=$(this),d.push(b)}),d=d.sort(function(a,b){return b.num-a.num}),d.forEach(function(a,c){a.li.find(".item-order").text(c+1),a.li.remove(),a.li.appendTo(b)})});var e=!0;$("#sortByTime").click(function(a){a.preventDefault();var b=$(".tab-pane.active").find("ol"),c=b.find("li"),d=[];c.each(function(){var a=Number($(this).attr("data-order")),b={};b.order=a,b.li=$(this),d.push(b)}),d=d.sort(e?function(a,b){return a.order-b.order}:function(a,b){return b.order-a.order}),e=!e,d.forEach(function(a,c){a.li.find(".item-order").text(c+1),a.li.remove(),a.li.appendTo(b)})}),$("#myModal form").submit(function(c){c.preventDefault();var d=$(this).serialize();if(d+="&action=update",a){$("#myModal").modal("hide");var e=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>请等待上次操作反馈后再提交更新..</p></div>');e.prependTo($(".infoBox")[0])}else $.ajax({type:"POST",timeout:b,url:"/ajaxPost",data:d,success:function(a){if(a=JSON.parse(a),a.status){var b=$("#star-"+a.starid);b.attr({"data-remark":a.remark}),b.attr({"data-original-title":a.remark}),b.attr({"data-category":a.category});for(var c=[],d=0;d<a.category.length;d++)c.push(a.category.charCodeAt(d));a.categoryCodes=c.join("-");var e=$("#content-"+a.categoryCodes);if(b.length)if(e.length){var f=b.closest("div.tab-pane");if(a.categoryCodes===f.attr("id").replace("content-",""));else{b.nextAll().each(function(){var a=$(this).find(".item-order").text();$(this).find(".item-order").text(--a)});var g=e.find("ol").first();if(b.find(".item-order").text(g.find("li").length+1),b.appendTo(g),0===f.find("li").length){var h=f.attr("id");h=h.replace("content","tab"),$("#"+h).remove(),f.remove(),e.addClass("active in");var i=e.attr("id");i=i.replace("content","tab"),$("#"+i).addClass("active")}else{var j=f.attr("id");j=j.replace("content","tab"),$("#"+j).find(".badge").text(f.find("li").length)}var k=e.attr("id");k=k.replace("content","tab"),$("#"+k).find(".badge").text(e.find("li").length)}var l=$('<div class="row alert alert-success alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>更新成功</p></div>');l.prependTo($(".infoBox")[0])}else{var m=b.closest("div.tab-pane");b.nextAll().each(function(){var a=$(this).find(".item-order").text();$(this).find(".item-order").text(--a)}),b.find(".item-order").text("1");var n=$('<div id="content-'+a.categoryCodes+'" class="tab-pane fade"><section id="star"><ol></ol></section></div>');n.appendTo($("div.tab-content")[0]);var o=n.find("ol").first();b.prependTo(o);var p=$('<li id="tab-'+a.categoryCodes+'"><a data-toggle="tab" href="#content-'+a.categoryCodes+'">'+a.category+'<span class="badge">1</span></a></li>');if(p.appendTo($("#myTab")[0]),0===m.find("li").length){var q=m.attr("id");q=q.replace("content","tab"),$("#"+q).remove(),m.remove(),p.addClass("active"),n.addClass("active in")}else{var r=m.attr("id");r=r.replace("content","tab"),$("#"+r).find(".badge").text(m.find("li").length)}var s=$('<div class="row alert alert-success alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>更新成功</p></div>');s.prependTo($(".infoBox")[0])}else{var t=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>找不到元素</p></div>');t.prependTo($(".infoBox")[0])}}else{var u=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>'+a.message+"</p></div>");u.prependTo($(".infoBox")[0])}},error:function(){var a=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>更新超时</p></div>');a.prependTo($(".infoBox")[0])}})}),$(document).ajaxStart(function(){var b=$('<div id="loading-info" class="row alert alert-info alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>正在更新，等待服务器反馈..</p></div>');b.prependTo($(".infoBox")[0]),console.log("loading"),a=!0,$("#myModal").modal("hide")}).ajaxStop(function(){$("#loading-info").remove(),console.log("done"),a=!1})});