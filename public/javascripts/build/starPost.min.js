/*! MyGitStars 09-04-2014 */
$(document).ready(function(){"use strict";var a=!1,b=1e4,c=3e3,d=$("#navHeader").attr("data-active");d&&$("#"+d).addClass("active"),$(".tab-content").mouseover(function(a){$(a.target).closest("li").tooltip("show")}),$("#myTab a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#myTab").find("li").first().addClass("active"),$(".tab-content").find("div").first().addClass("active in"),$(".tab-content").click(function(a){a.preventDefault();var b=$(a.target).closest("li"),c=b.find(".star-name").text(),d=b.find(".star-description").text(),e=b.find(".star-owner").text(),f=$("#myModal");f.find(".modal-id").val(b.attr("data-id")),f.find(".modal-title").text(c),f.find(".modal-owner").text(e),f.find(".modal-language").text(b.find(".star-language").text()),f.find(".modal-starNum").text(b.attr("data-starNum")),f.find(".modal-forkNum").text(b.attr("data-forkNum")),f.find(".modal-description").text(d),f.find(".modal-htmlurl").attr({href:b.attr("data-htmlurl")}),f.find("#readmeBtn").attr({href:"/readme?author="+e+"&repo="+c,"data-target":"#readme-"+b.attr("data-id")});var g=b.attr("data-category");f.find(".modal-category input").text(g),f.find(".modal-category input").val(g);var h=b.attr("data-remark");f.find(".modal-remark textarea").text(h),f.find(".modal-remark textarea").val(h),$("#myModal").modal()}),$("#sortByStar").click(function(a){a.preventDefault();var b=$(".tab-pane.active").find("ol"),c=b.find("li"),d=[];c.each(function(){var a=Number($(this).attr("data-starNum")),b={};b.num=a,b.li=$(this),d.push(b)}),d=d.sort(function(a,b){return b.num-a.num}),d.forEach(function(a,c){a.li.find(".item-order").text(c+1),a.li.remove(),a.li.appendTo(b)})});var e=!0;$("#sortByTime").click(function(a){a.preventDefault();var b=$(".tab-pane.active").find("ol"),c=b.find("li"),d=[];c.each(function(){var a=Number($(this).attr("data-order")),b={};b.order=a,b.li=$(this),d.push(b)}),d=d.sort(e?function(a,b){return a.order-b.order}:function(a,b){return b.order-a.order}),e=!e,d.forEach(function(a,c){a.li.find(".item-order").text(c+1),a.li.remove(),a.li.appendTo(b)})});var f=function(a,b){a&&setTimeout(function(){a&&a.animate({opacity:0},300,function(){a&&a.remove()})},b)};$("#myModal form").submit(function(d){d.preventDefault();var e=$(this).serialize();if(e+="&action=update",console.log(e),a){$("#myModal").modal("hide");var g=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>请等待上次操作反馈后再提交更新..</p></div>');g.prependTo($(".infoBox")[0]),f(g,c)}else $.ajax({type:"POST",timeout:b,url:"/ajaxPost",data:e,success:function(b){if(a=!1,b=JSON.parse(b),b.status){var d=$("#star-"+b.starid);d.attr({"data-remark":b.remark}),d.attr({"data-original-title":b.remark}),d.attr({"data-category":b.category});for(var e=[],g=0;g<b.category.length;g++)e.push(b.category.charCodeAt(g));b.categoryCodes=e.join("-");var h=$("#content-"+b.categoryCodes);if(d.length)if(h.length){var i=d.closest("div.tab-pane");if(b.categoryCodes===i.attr("id").replace("content-",""));else{d.nextAll().each(function(){var a=$(this).find(".item-order").text();$(this).find(".item-order").text(--a)});var j=h.find("ol").first();if(d.find(".item-order").text(j.find("li").length+1),d.appendTo(j),0===i.find("li").length){var k=i.attr("id");k=k.replace("content","tab"),$("#"+k).remove(),i.remove(),h.addClass("active in");var l=h.attr("id");l=l.replace("content","tab"),$("#"+l).addClass("active")}else{var m=i.attr("id");m=m.replace("content","tab"),$("#"+m).find(".badge").text(i.find("li").length)}var n=h.attr("id");n=n.replace("content","tab"),$("#"+n).find(".badge").text(h.find("li").length)}var o=$('<div class="row alert alert-success alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>更新成功</p></div>');o.prependTo($(".infoBox")[0]),f(o,c)}else{var p=d.closest("div.tab-pane");d.nextAll().each(function(){var a=$(this).find(".item-order").text();$(this).find(".item-order").text(--a)}),d.find(".item-order").text("1");var q=$('<div id="content-'+b.categoryCodes+'" class="tab-pane fade"><section id="star"><ol></ol></section></div>');q.appendTo($("div.tab-content")[0]);var r=q.find("ol").first();d.prependTo(r);var s=$('<li id="tab-'+b.categoryCodes+'"><a data-toggle="tab" href="#content-'+b.categoryCodes+'">'+b.category+'<span class="badge">1</span></a></li>');if(s.appendTo($("#myTab")[0]),0===p.find("li").length){var t=p.attr("id");t=t.replace("content","tab"),$("#"+t).remove(),p.remove(),s.addClass("active"),q.addClass("active in")}else{var u=p.attr("id");u=u.replace("content","tab"),$("#"+u).find(".badge").text(p.find("li").length)}var v=$('<div class="row alert alert-success alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>更新成功</p></div>');v.prependTo($(".infoBox")[0]),f(v,c)}else{var w=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>找不到元素</p></div>');w.prependTo($(".infoBox")[0]),f(w,c)}}else{var x=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>'+b.message+"</p></div>");x.prependTo($(".infoBox")[0]),f(x,c)}},error:function(){a=!1;var b=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>更新超时</p></div>');b.prependTo($(".infoBox")[0]),f(b,c)}}),a=!0,$("#myModal").modal("hide")}),$("#readmeBtn").click(function(a){a.preventDefault();var b=$(this).closest(".modal"),c=b.find(".modal-id").val();if(console.log("id: ",c),$("#myModal").modal("hide"),$("#readme-"+c).length)console.log("exist"),$("#readme-"+c).modal("show");else{console.log("create");var d=$('<div id="readme-'+c+'" class="modal fade"></div>'),e=$('<div class="modal-dialog"></div>'),f=$('<div class="modal-content"></div>'),g=$('<div class="modal-header"></div>'),h=$('<button class="close" type="button" data-dismiss="modal" aria-hidden="true">&times;</button>'),i=$('<p class="modal-title">加载中..</p>'),j=$('<div class="modal-footer"></div>');h.appendTo(g),i.appendTo(g),g.appendTo(f),j.appendTo(f),f.appendTo(e),e.appendTo(d),d.appendTo($("#container")[0]),d.modal({remote:$(this).attr("href")})}}),$(document).ajaxStart(function(){var a=$('<div id="loading-info" class="row alert alert-info alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>请等待服务器反馈..</p></div>');a.prependTo($(".infoBox")[0]),f(a,c)}).ajaxStop(function(){$("#loading-info").length&&$("#loading-info").remove()})});