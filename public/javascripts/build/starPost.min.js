/*! MyGitStars 08-04-2014 */
$(document).ready(function(){"use strict";var a=!1,b=1e4,c=3e3,d=$("#navHeader").attr("data-active");d&&$("#"+d).addClass("active");var e=function(a,b){a&&setTimeout(function(){a.animate({opacity:0,height:"toggle"},1e3,function(){a&&a.remove()})},b)};$(".tab-content").mouseover(function(a){$(a.target).closest("li").tooltip("show")}),$("#myTab a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#myTab").find("li").first().addClass("active"),$(".tab-content").find("div").first().addClass("active in"),$(".tab-content").click(function(a){a.preventDefault();var b=$(a.target).closest("li"),c=b.find(".star-name").text(),d=b.find(".star-description").text(),e=b.find(".star-owner").text(),f=$("#myModal");f.find(".modal-id").val(b.attr("data-id")),f.find(".modal-title").text(c),f.find(".modal-owner").text(e),f.find(".modal-language").text(b.find(".star-language").text()),f.find(".modal-starNum").text(b.attr("data-starNum")),f.find(".modal-forkNum").text(b.attr("data-forkNum")),f.find(".modal-repoId").text("ID: "+b.attr("data-id")),f.find(".modal-description").text(d),f.find(".modal-htmlurl").attr({href:b.attr("data-htmlurl")}),f.find(".modal-readme").attr({href:"/readme?author="+e+"&repo="+c}),f.find(".modal-size").text(b.attr("data-size")+"KB");var g=b.attr("data-category");f.find(".modal-category input").text(g),f.find(".modal-category input").val(g);var h=b.attr("data-remark");f.find(".modal-remark textarea").text(h),f.find(".modal-remark textarea").val(h),$("#myModal").modal()}),$("#sortByStar").click(function(a){a.preventDefault();var b=$(".tab-pane.active").find("ol"),c=b.find("li"),d=[];c.each(function(){var a=Number($(this).attr("data-starNum")),b={};b.num=a,b.li=$(this),d.push(b)}),d=d.sort(function(a,b){return b.num-a.num}),d.forEach(function(a,c){a.li.find(".item-order").text(c+1),a.li.remove(),a.li.appendTo(b)})});var f=!0;$("#sortByTime").click(function(a){a.preventDefault();var b=$(".tab-pane.active").find("ol"),c=b.find("li"),d=[];c.each(function(){var a=Number($(this).attr("data-order")),b={};b.order=a,b.li=$(this),d.push(b)}),d=d.sort(f?function(a,b){return a.order-b.order}:function(a,b){return b.order-a.order}),f=!f,d.forEach(function(a,c){a.li.find(".item-order").text(c+1),a.li.remove(),a.li.appendTo(b)})}),$("#myModal form").submit(function(d){d.preventDefault();var f=$(this).serialize();if(f+="&action=update",a){$("#myModal").modal("hide");var g=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>请等待上次操作反馈后再提交更新..</p></div>');g.prependTo($(".infoBox")[0]),e(g,c)}else $.ajax({type:"POST",timeout:b,url:"/ajaxPost",data:f,success:function(a){if(a=JSON.parse(a),a.status){var b=$("#star-"+a.starid);b.attr({"data-remark":a.remark}),b.attr({"data-original-title":a.remark}),b.attr({"data-category":a.category});for(var d=[],f=0;f<a.category.length;f++)d.push(a.category.charCodeAt(f));a.categoryCodes=d.join("-");var g=$("#content-"+a.categoryCodes);if(b.length)if(g.length){var h=b.closest("div.tab-pane");if(a.categoryCodes===h.attr("id").replace("content-",""));else{b.nextAll().each(function(){var a=$(this).find(".item-order").text();$(this).find(".item-order").text(--a)});var i=g.find("ol").first();if(b.find(".item-order").text(i.find("li").length+1),b.appendTo(i),0===h.find("li").length){var j=h.attr("id");j=j.replace("content","tab"),$("#"+j).remove(),h.remove(),g.addClass("active in");var k=g.attr("id");k=k.replace("content","tab"),$("#"+k).addClass("active")}else{var l=h.attr("id");l=l.replace("content","tab"),$("#"+l).find(".badge").text(h.find("li").length)}var m=g.attr("id");m=m.replace("content","tab"),$("#"+m).find(".badge").text(g.find("li").length)}var n=$('<div class="row alert alert-success alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>更新成功</p></div>');n.prependTo($(".infoBox")[0]),e(n,c)}else{var o=b.closest("div.tab-pane");b.nextAll().each(function(){var a=$(this).find(".item-order").text();$(this).find(".item-order").text(--a)}),b.find(".item-order").text("1");var p=$('<div id="content-'+a.categoryCodes+'" class="tab-pane fade"><section id="star"><ol></ol></section></div>');p.appendTo($("div.tab-content")[0]);var q=p.find("ol").first();b.prependTo(q);var r=$('<li id="tab-'+a.categoryCodes+'"><a data-toggle="tab" href="#content-'+a.categoryCodes+'">'+a.category+'<span class="badge">1</span></a></li>');if(r.appendTo($("#myTab")[0]),0===o.find("li").length){var s=o.attr("id");s=s.replace("content","tab"),$("#"+s).remove(),o.remove(),r.addClass("active"),p.addClass("active in")}else{var t=o.attr("id");t=t.replace("content","tab"),$("#"+t).find(".badge").text(o.find("li").length)}var u=$('<div class="row alert alert-success alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>更新成功</p></div>');u.prependTo($(".infoBox")[0]),e(u,c)}else{var v=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>找不到元素</p></div>');v.prependTo($(".infoBox")[0]),e(v,c)}}else{var w=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>'+a.message+"</p></div>");w.prependTo($(".infoBox")[0]),e(w,c)}},error:function(){var a=$('<div class="row alert alert-danger alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>更新超时</p></div>');a.prependTo($(".infoBox")[0]),e(a,c)}})}),$(document).ajaxStart(function(){var b=$('<div id="loading-info" class="row alert alert-info alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>正在更新，等待服务器反馈..</p></div>');b.prependTo($(".infoBox")[0]),console.log("loading"),a=!0,$("#myModal").modal("hide")}).ajaxStop(function(){$("#loading-info").remove(),console.log("done"),a=!1})});