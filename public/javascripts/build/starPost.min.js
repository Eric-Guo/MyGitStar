/*! MyGitStars 24-04-2014 */
$(document).ready(function(){"use strict";function a(b){$.contains($(".add").next()[0],b.target)||($(".add").popover("hide"),$("body").unbind("click",a))}function b(a){var b=$("#categoryTable").find("tbody"),c=$("<tr data-category="+a+"><td>"+a+"</td></tr>");c.appendTo(b),c.find(".delete").mouseover(function(){$(this).tooltip("show")})}var c=!1,d=15e3,e=2e3,f=$("#navHeader").attr("data-active");f&&$("#"+f).addClass("active"),$(".tab-content").mouseover(function(a){$(a.target).closest("li").tooltip("show")}),$(".delete").mouseover(function(){$(this).tooltip("show")}),$("#myTab a").click(function(a){a.preventDefault(),$(this).tab("show")}),$("#myTab").find("li").first().addClass("active"),$(".tab-content").find("div").first().addClass("active in"),$(".add").popover(),$(".add").on("shown.bs.popover",function(){$(this).next().find('input[name="newCategory"]').focus().val(""),$("body").click(a),$("#closePopover").click(function(b){b.preventDefault(),$(".add").popover("hide"),$("body").unbind("click",a)}),$("#addCategory").closest("form").submit(function(a){a.preventDefault();var c=$(this).find('input[name="newCategory"]').val();""===c?j("danger","分类非空！"):0!==$("#categoryTable").find("tr[data-category="+c+"]").length?j("danger","该分类已经存在！"):(b(c),j("success","添加分类成功！"));var d=$("#myModal"),e=d.find('select[name="category"]');e.children().each(function(){$(this).remove()});var f=$("#categoryTable").find("tr");f.each(function(){var a=$(this).find("td").first().text(),b=$("<option value="+a+">"+a+"</option>");b.appendTo(e)}),e.val($("#star-"+d.find(".modal-id").val()).attr("data-category")),$("#closePopover").click()})}),$(".tab-content").click(function(a){a.preventDefault();var b=$(a.target).closest("li"),c=b.find(".star-name").text(),d=b.find(".star-description").text(),e=b.find(".star-owner").text(),f=$("#myModal");f.find(".modal-id").val(b.attr("data-id")),f.find(".modal-title").text(c),f.find(".modal-owner").text(e),f.find(".modal-language").text(b.find(".star-language").text()),f.find(".modal-starNum").text(b.attr("data-starNum")),f.find(".modal-forkNum").text(b.attr("data-forkNum")),f.find(".modal-description").text(d),f.find(".modal-htmlurl").attr({href:b.attr("data-htmlurl")}),f.find("#readmeBtn").attr({href:"/readme?author="+e+"&repo="+c,"data-target":"#readme-"+b.attr("data-id")});var g=b.attr("data-category");f.find(".modal-category input").text(g),f.find(".modal-category input").val(g);var h=f.find('select[name="category"]');h.children().each(function(){$(this).remove()});var i=$("#categoryTable").find("tr");i.each(function(){var a=$(this).find("td").first().text(),b=$("<option value="+a+">"+a+"</option>");b.appendTo(h)}),h.val(b.attr("data-category"));var j=b.attr("data-remark");f.find(".modal-remark textarea").text(j),f.find(".modal-remark textarea").val(j),$("#myModal").modal()}),$("#sortByStar").click(function(a){a.preventDefault();var b=$(".tab-pane.active").find("ol"),c=b.find("li"),d=[];c.each(function(){var a=Number($(this).attr("data-starNum")),b={};b.num=a,b.li=$(this),d.push(b)}),d=d.sort(function(a,b){return b.num-a.num}),d.forEach(function(a,c){a.li.find(".item-order").text(c+1),a.li.remove(),a.li.appendTo(b)})});var g=!0;$("#sortByTime").click(function(a){a.preventDefault();var b=$(".tab-pane.active").find("ol"),c=b.find("li"),d=[];c.each(function(){var a=Number($(this).attr("data-order")),b={};b.order=a,b.li=$(this),d.push(b)}),d=d.sort(g?function(a,b){return a.order-b.order}:function(a,b){return b.order-a.order}),g=!g,d.forEach(function(a,c){a.li.find(".item-order").text(c+1),a.li.remove(),a.li.appendTo(b)})});var h=function(a,b){a&&setTimeout(function(){a&&a.animate({opacity:0},300,function(){a&&a.remove()})},b)};$('textarea[name="remark"]').focus(function(){var a=this;setTimeout(function(){a.select()},30)});var i=function(a,b,c){for(var d=$("#star-"+a),e=[],f=0;f<c.length;f++)e.push(c.charCodeAt(f));var g=e.join("-"),h=$("#content-"+g);if(d.length){var i=d.closest("div.tab-pane");if(d.nextAll().each(function(){var a=$(this).find(".item-order").text();$(this).find(".item-order").text(--a)}),h.length){var k=h.find("ol").first();d.find(".item-order").text(k.find("li").length+1),d.appendTo(k);var l=h.attr("id");l=l.replace("content","tab"),$("#"+l).find(".badge").text(h.find("li").length)}else{d.find(".item-order").text("1"),h=$('<div id="content-'+g+'" class="tab-pane fade"><section id="star"><ol></ol></section></div>'),h.appendTo($("div.tab-content")[0]);var m=h.find("ol").first();d.prependTo(m);var n=$('<li id="tab-'+g+'"><a data-toggle="tab" href="#content-'+g+'">'+c+'<span class="badge">1</span></a></li>');n.appendTo($("#myTab")[0])}if(0===i.find("li").length){var l=i.attr("id");l=l.replace("content","tab"),$("#"+l).remove(),i.remove(),h.addClass("active in");var o=h.attr("id");o=o.replace("content","tab"),$("#"+o).addClass("active")}else{var p=i.attr("id");p=p.replace("content","tab"),$("#"+p).find(".badge").text(i.find("li").length)}}else j("danger","找不到元素")},j=function(a,b){var c=$('<div class="row alert alert-'+a+' alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>'+b+"</p></div>");c.prependTo($(".infoBox")[0]),h(c,e)};$("#myModal form").submit(function(a){a.preventDefault();var b=$(this).serialize();b+="&action=update",c?($("#myModal").modal("hide"),j("danger","请等待上次操作反馈后再提交更新..")):($.ajax({type:"POST",timeout:d,url:"/ajaxPost",data:b,success:function(a){if(c=!1,a=JSON.parse(a),a.status){var b=$("#star-"+a.starid);b.attr({"data-remark":a.remark}),b.attr({"data-original-title":a.remark});var d=b.attr("data-category");b.attr({"data-category":a.category}),d!==a.category&&i(a.starid,d,a.category),j("success","更新成功")}else j("danger",a.message)},error:function(){c=!1,j("danger","更新超时")}}),c=!0,$("#myModal").modal("hide"))}),$("#readmeBtn").click(function(a){a.preventDefault();var b=$(this).closest(".modal"),c=b.find(".modal-id").val();if($("#myModal").modal("hide"),$("#readme-"+c).length)$("#readme-"+c).modal("show");else{console.log("create");var d=$('<div id="readme-'+c+'" class="modal fade"></div>'),e=$('<div class="modal-dialog"></div>'),f=$('<div class="modal-content"></div>'),g=$('<div class="modal-header"></div>'),h=$('<button class="close" type="button" data-dismiss="modal" aria-hidden="true">&times;</button>'),i=$('<p class="modal-title">加载中..</p>'),j=$('<div class="modal-footer"></div>');h.appendTo(g),i.appendTo(g),g.appendTo(f),j.appendTo(f),f.appendTo(e),e.appendTo(d),d.appendTo($("#container")[0]),d.modal({remote:$(this).attr("href")})}}),$(document).ajaxStart(function(){var a=$('<div id="loading-info" class="row alert alert-info alert-dismissable"><button class="close" type="button" data-dismiss="alert" aria-hidden="true">&times;</button><p>请等待服务器反馈..</p></div>');a.prependTo($(".infoBox")[0]),h(a,e)}).ajaxStop(function(){$("#loading-info").length&&$("#loading-info").remove()})});